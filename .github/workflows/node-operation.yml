name: Node Operation

on:
  workflow_call:
    inputs:
      runs-on:
        default: self-hosted
        required: true
        type: string
      node-name:
        default: node01
        required: true
        type: string
      service:
        default: docker-socket-proxy
        required: false
        type: string
    secrets:
      telegram_token:
        required: true
      telegram_to:
        required: true

env:
  NODE_DOCKER_PATH: /home/${{ secrets.USER }}/www
  NODE_CRONJOB_PATH: /var/spool/cron/crontabs/${{ secrets.USER }}

jobs:

  deploy:
    runs-on: ${{ inputs.runs-on }}
    if: contains(github.event.head_commit.message, 'deploy') && !github.event_name == 'pull request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup docker
        if: contains(github.event.head_commit.message, 'standalone')
        run: |
          echo "Copying docker files to ${{ inputs.node-name }} server"
          cp ansible/files/${{ inputs.node-name }}/docker/compose-standalone.yml ${{ env.NODE_DOCKER_PATH }}
          docker compose -f ${{ env.NODE_DOCKER_PATH }}/compose-standalone.yml up -d

  telegram:
    needs: [deploy]
    if: ${{ always() }}
    uses: jd-apprentice/jd-workflows/.github/workflows/telegram.yml@main
    with:
      message: |
        _ğŸ“š Action Details_

        ğŸ“ Event Name: ${{ github.event_name }}

        _ğŸ“š Commit Details_

        ğŸ“ Actor: ${{ github.actor }}
        ğŸ“ Commit Message: ${{ github.event.head_commit.message }}
        ğŸ“ Commit Url: ${{ github.event.head_commit.url }}

        _ğŸ“š Repository Details_

        ğŸ“ Repository Name: ${{ github.repository }}
        ğŸ“ Repository Url: ${{ github.event.repository.url }}

        _ğŸ“š Workflow Details_

        ğŸ“ Workflow Name: ${{ github.workflow }} on ${{ inputs.node-name }}

      runs-on: ubuntu-latest
      name: Telegram Notification

    secrets:
      envTOKEN: ${{ secrets.telegram_token }}
      envTO: ${{ secrets.telegram_to }}
